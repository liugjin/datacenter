// Generated by IcedCoffeeScript 108.0.11

/*
* File: graphicparamter-box-directive
* User: James
* Date: 2019/03/29
* Desc:
 */
if (typeof define !== 'function') { var define = require('amdefine')(module) };
var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

define(['../base-directive', 'text!./style.css', 'text!./view.html', 'underscore', "moment"], function(base, css, view, _, moment) {
  var GraphicparamterBoxDirective, exports;
  GraphicparamterBoxDirective = (function(_super) {
    __extends(GraphicparamterBoxDirective, _super);

    function GraphicparamterBoxDirective($timeout, $window, $compile, $routeParams, commonService) {
      this.show = __bind(this.show, this);
      this.id = "graphicparamter-box";
      GraphicparamterBoxDirective.__super__.constructor.call(this, $timeout, $window, $compile, $routeParams, commonService);
    }

    GraphicparamterBoxDirective.prototype.setScope = function() {
      return {
        templateId: "@"
      };
    };

    GraphicparamterBoxDirective.prototype.setCSS = function() {
      return css;
    };

    GraphicparamterBoxDirective.prototype.applyChange = function() {
      return (function(_this) {
        return function() {
          return scope.$applyAsync();
        };
      })(this);
    };

    GraphicparamterBoxDirective.prototype.setTemplate = function() {
      return view;
    };

    GraphicparamterBoxDirective.prototype.show = function(scope, element, attrs) {
      var dom, ele, html, initializeGraphicOptions, initializeView;
      scope.count = 0;
      if (!scope.firstload) {
        return;
      }
      scope.graphic_parameters = {};
      if (scope.parameters.templateParameters) {
        scope.graphic_parameters = scope.parameters.templateParameters;
      }
      if (scope.parameters.templateId) {
        scope.templateId = {
          user: this.$routeParams.user,
          project: this.$routeParams.project,
          template: scope.parameters.templateId
        };
      } else {
        scope.templateId = {
          user: this.$routeParams.user,
          project: this.$routeParams.project,
          template: this.$routeParams.station
        };
      }
      scope.$watch("parameters", (function(_this) {
        return function(templateId) {
          if (!templateId) {
            return;
          }
          return scope.templateId = {
            user: _this.$routeParams.user,
            project: _this.$routeParams.project,
            template: scope.parameters.templateId,
            parameters: scope.parameters.templateParameters
          };
        };
      })(this));
      initializeView = (function(_this) {
        return function() {
          var _ref, _ref1, _ref2, _ref3, _ref4;
          if (_.isNull(document.getElementById('#element-placeholder'))) {
            setTimeout(initializeView, 1000);
            return;
          }
          _this.placeholder = $('#element-placeholder');
          if ((_ref = _this.placeholder) != null) {
            _ref.draggable();
          }
          _this.placeholderSize = {
            width: (_ref1 = _this.placeholder) != null ? _ref1.width() : void 0,
            height: (_ref2 = _this.placeholder) != null ? _ref2.height() : void 0,
            width2: ((_ref3 = _this.placeholder) != null ? _ref3.width() : void 0) / 2,
            height2: ((_ref4 = _this.placeholder) != null ? _ref4.height() : void 0) / 2
          };
          _this.popover = $('#element-placeholder-popover');
          return _this.viewerPosition = $('#player').offset();
        };
      })(this);
      initializeGraphicOptions = (function(_this) {
        return function() {
          var _ref, _ref1, _ref2, _ref3, _ref4;
          return scope.graphicOptions = {
            engineOptions: {
              parameters: _this.$routeParams
            },
            renderOptions: {
              editable: false,
              type: (_ref = (_ref1 = _this.$routeParams.renderer) != null ? _ref1 : (_ref2 = _this.$rootScope) != null ? _ref2.renderType : void 0) != null ? _ref : 'snapsvg',
              uploadUrl: typeof window !== "undefined" && window !== null ? (_ref3 = window.setting) != null ? (_ref4 = _ref3.urls) != null ? _ref4.uploadUrl : void 0 : void 0 : void 0
            }
          };
        };
      })(this);
      initializeGraphicOptions();
      initializeView();
      html = '<div class=\'box-hexagon\'>\n  <div class=\'big-box-border-top\'></div>\n  <div class=\'box-content\'>\n    <div id="player" ng-dblclick="controller.showPopover($event)">\n        <div graphic-player="graphic-player" options="graphicOptions" template-id = "templateId"\n             controller="controller" on-template-load="controller.onTemplateLoad()"\n             on-element-changed="controller.onElementChanged()" parameters="graphic_parameters"\n             class="graphic-viewer"></div>\n    </div>\n  </div>\n  <div class=\'big-box-border-bottom\'></div>\n</div>';
      scope.element = element;
      ele = this.$compile(html)(scope);
      dom = $(element.find("#graphicparamter")[0]);
      dom.empty();
      return scope.updateDomState = setTimeout((function(_this) {
        return function() {
          return dom.append(ele);
        };
      })(this), 100);
    };

    GraphicparamterBoxDirective.prototype.resize = function(scope) {
      scope.count++;
      scope.templateId.refresh = scope.count;
      return scope.parameters.templateId.refresh = scope.count;
    };

    GraphicparamterBoxDirective.prototype.dispose = function(scope) {
      var _ref;
      window.clearTimeout(scope.updateDomState);
      if ((_ref = scope.element.find("#graphicparamter")) != null) {
        _ref.empty();
      }
      scope.templateId = null;
      return this.placeholder = null;
    };

    return GraphicparamterBoxDirective;

  })(base.BaseDirective);
  return exports = {
    GraphicparamterBoxDirective: GraphicparamterBoxDirective
  };
});
